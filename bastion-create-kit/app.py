from flask import Flask, render_template, request, flash, redirect, url_for
import subprocess
import os

app = Flask(__name__)
# flash ë©”ì‹œì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì‹œí¬ë¦¿ í‚¤
app.config['SECRET_KEY'] = 'a-very-secret-key-that-should-be-changed'

# Kickstart í…œí”Œë¦¿
KS_TEMPLATE = """
# Kickstart file for RHEL 9.6 Bastion VM - Generated by WebUI
lang en_US.UTF-8
keyboard --xlayouts='us'
timezone Asia/Seoul --utc
rootpw --plaintext ##ROOT_PASSWORD##

# --- í•µì‹¬ íŒŒí‹°ì…˜ ì„¤ì • ---
# 1. ë””ìŠ¤í¬ì˜ ëª¨ë“  íŒŒí‹°ì…˜ì„ ê¹¨ë—í•˜ê²Œ ì§€ì›ë‹ˆë‹¤.
clearpart --all --initlabel

# 2. ìë™ìœ¼ë¡œ íŒŒí‹°ì…˜ì„ ì„¤ì •í•©ë‹ˆë‹¤.
#    - /boot íŒŒí‹°ì…˜ê³¼ swap íŒŒí‹°ì…˜ì€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
#    - --nohome ì˜µì…˜ìœ¼ë¡œ /home íŒŒí‹°ì…˜ì„ ë§Œë“¤ì§€ ì•Šê³ ,
#      ë‚¨ì€ ëª¨ë“  ê³µê°„ì„ ë£¨íŠ¸(/) íŒŒí‹°ì…˜ì— í• ë‹¹í•©ë‹ˆë‹¤.
autopart --nohome


# BaseOSì™€ AppStream ë¦¬í¬ì§€í† ë¦¬ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
url --url="http://##HTTP_SERVER_IP##:8080/rhel9.6/BaseOS"
repo --name="AppStream" --baseurl="http://##HTTP_SERVER_IP##:8080/rhel9.6/AppStream"

network --bootproto=static --device=enp1s0 --ip=192.168.122.100 --netmask=255.255.255.0 --gateway=192.168.0.1 --nameserver=8.8.8.8,8.8.4.4 --hostname=##HOSTNAME## --activate
services --enabled="chronyd,httpd,named"
firewall --enabled --service=ssh,http,https
bootloader --location=mbr --boot-drive=vda
zerombr
clearpart --all --initlabel
autopart --type=lvm
graphical

%packages
@^graphical-server-environment
haproxy
bind
bind-utils
chrony
httpd
httpd-tools
python3
python3-pip
ansible-core
nmstate
wget
podman
skopeo
jq
tar
gcc
python3-devel
rsync
policycoreutils-python-utils
%end



%post --log=/root/ks-post.log
pip3 install Flask Flask-WTF


# Add user with specified password
useradd user
echo 'user:Redhat123!@#' | chpasswd



# ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì´ë¦„ í™•ì¸ (ì˜ˆ: ens3 ë˜ëŠ” enp1s0 ë“±)
IFACE=$(nmcli device status | grep ethernet | awk '{print $1}' | head -n1)

echo "ì„¤ì •í•  ì¸í„°í˜ì´ìŠ¤: $IFACE"

# ê¸°ì¡´ connection ì´ë¦„ í™•ì¸ (ë³´í†µì€ interface ì´ë¦„ê³¼ ë™ì¼í•¨)
CONNAME=$(nmcli -t -f NAME,DEVICE connection show | grep "$IFACE" | cut -d: -f1)

echo "ê¸°ì¡´ ì—°ê²° ì´ë¦„: $CONNAME"

# ê¸°ì¡´ ì„¤ì • ì‚­ì œ ë° ìƒˆ ì„¤ì • ìƒì„±
#nmcli connection modify "$CONNAME" ipv4.method manual ipv4.addresses 192.168.122.100/24 ipv4.gateway 192.168.122.1
#nmcli connection down "$CONNAME"
#nmcli connection up "$CONNAME"

%end

reboot
"""

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        action = request.form.get('action')
        try:
            if action == 'generate_kickstart':
                ks_content = KS_TEMPLATE.replace("##ROOT_PASSWORD##", request.form.get('root_password')) \
                                        .replace("##HTTP_SERVER_IP##", request.form.get('http_server_ip')) \
                                        #.replace("##IP_ADDRESS##", request.form.get('ip_address')) \
                                        #.replace("##SUBNET##", request.form.get('subnet')) \
                                        .replace("##HOSTNAME##", request.form.get('hostname'))

                ks_path = "/var/www/html/kickstart/ks.cfg"
                with open(ks_path, "w") as f:
                    f.write(ks_content)
                
                subprocess.run(['sudo', 'restorecon', '-v', ks_path], check=True)
                flash(f"âœ… Kickstart íŒŒì¼ì´ {ks_path} ì— ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.", 'success')

            elif action == 'download_iso':
                # ì‚¬ìš©ìê°€ ì…ë ¥í•œ URLì„ ê°€ì ¸ì˜µë‹ˆë‹¤
                iso_url = request.form.get('iso_url_from_user')
                if not iso_url or not iso_url.startswith('http'):
                    flash("âŒ ì˜¤ë¥˜: ìœ íš¨í•œ ë‹¤ìš´ë¡œë“œ URLì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.", 'danger')
                    return redirect(url_for('index'))

                # ë‹¤ìš´ë¡œë“œë  íŒŒì¼ ì´ë¦„ ì§€ì • (URLì´ ë³µì¡í•˜ë¯€ë¡œ ê³ ì •ëœ ì´ë¦„ ì‚¬ìš©)
                iso_filename = "rhel-9.6-x86_64-dvd.iso"
                download_path = f"/tmp/{iso_filename}"
                mount_path = "/var/www/html/rhel9.6"

                flash(f"ISO ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤... (ëŒ€ìƒ: {mount_path})", 'info')
                
                # wgetê³¼ mount ì‹¤í–‰
                subprocess.run(['sudo', 'wget', '-O', download_path, iso_url], check=True)
                subprocess.run(['sudo', 'mount', '-o', 'loop', download_path, mount_path], check=True)
                
                flash(f"âœ… ISO ì´ë¯¸ì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œí•˜ê³  {mount_path} ì— ë§ˆìš´íŠ¸í–ˆìŠµë‹ˆë‹¤.", 'success')
            
            elif action == 'create_vm':
                http_server_ip = request.form.get('http_server_ip')
                
                location_url = f"http://{http_server_ip}:8080/rhel9.6"
                ks_location = f"http://{http_server_ip}:8080/kickstart/ks.cfg"

                virt_install_cmd = [
                    'sudo', 'virt-install',
                    '--name', 'rhel96-bastion',
                    '--ram', '16384',
                    '--vcpus', '8',
                    '--disk', 'path=/rhel96-bastion.qcow2,size=50',
                    '--os-variant', 'rhel9.4',
                    '--network', 'bridge=virbr0',
                    '--graphics', 'vnc,listen=0.0.0.0',
                    '--location', location_url,
                    f'--extra-args=inst.ks={ks_location}',
                    '--noautoconsole'
                ]
                
                result = subprocess.run(virt_install_cmd, capture_output=True, text=True, check=True)
                flash("ğŸš€ VM ìƒì„± ëª…ë ¹ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤. `virt-manager` ë˜ëŠ” `virsh list`ë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.", 'success')

        except subprocess.CalledProcessError as e:
            flash(f"âŒ ëª…ë ¹ì–´ ì‹¤í–‰ ì˜¤ë¥˜: {e.stderr}", 'danger')
        except Exception as e:
            flash(f"âŒ ì¼ë°˜ ì˜¤ë¥˜ ë°œìƒ: {e}", 'danger')

        return redirect(url_for('index'))

    return render_template('index.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5011, debug=True)
